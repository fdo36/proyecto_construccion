<script type="text/javascript">
  function show_rut(s) {

    if(s.value == "")
    {      
      $('#rut').val("-"); 
      $('#codigo').val("-");
    }
    
    $.get("/destinations/"+s.value+".json", function(data) {
     $('#rut').val(data.rut); 
     $('#codigo').val(data.code);
   });
  }
  
</script>

<script type="text/javascript">
  function search_rut(s) {   
      
    if(s.value=="")
    {           
      $('#select_destination').val("");
      $('#rut').val("-");      
      $('#codigo').val("-");
    }

    else
    {      
      $.get("/destinations.json", function(data) {       
       
       var encontrado = false;       
       
       for (var i = data.length - 1; i >= 0; i--) {
        if(data[i]["rut"]==s.value){
          $('#rut').val(s.value); 
          $('#select_destination').val([data[i]["name"], data[i]["id"]]);
          $('#codigo').val(data[i]["code"]); 
          encontrado = true;                  
        }
       };
       if(!encontrado)
       {
          $('#select_destination').val("");
          $('#rut').val("-");      
          $('#codigo').val("-");
       }

      });      
  }  
}
</script>

<script type="text/javascript">
  function search_code(s) {   
      
    if(s.value=="")
    {           
      $('#select_destination').val("");
      $('#rut').val("-");      
      $('#codigo').val("-");
    }

    else
    {      
      $.get("/destinations.json", function(data) {       
       
       var encontrado = false;       
       
       for (var i = data.length - 1; i >= 0; i--) {
        if(data[i]["code"]==s.value){
          $('#rut').val(data[i]["rut"]); 
          $('#select_destination').val([data[i]["name"], data[i]["id"]]);
          $('#codigo').val(s.value);
          encontrado = true;                  
        }
       };
       if(!encontrado)
       {
          $('#select_destination').val("");
          $('#rut').val("-");      
          $('#codigo').val("-");
       }
             
      });      
  }  
}
</script>




<div class="box">
<%= form_for(@dispatch) do |f| %>
  <% if @dispatch.errors.any? %>
    <div id="error_explanation">
      <h2><%= @dispatch.errors.count > 1 ? "#{@dispatch.errors.count} errores." : "#{@dispatch.errors.count} error." %> No se puede guardar el despacho:</h2>
      <ul>
      <% @dispatch.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class = "contentSubPanel">
    
    <div class="line-forme">
      <div class="forme-lab">
        <label>Destino </label>
        <em class="formee-req">*</em>
      </div>    
      <div class="forme-in">
        <% @options = Destination.all.map { |d| [d.name, d.id] } %>
        <%= f.select(:destination_id, options_for_select(@options), {:selected => :prompt, :prompt => '- Seleccione destino - '} , :id => 'select_destination', :onchange => "show_rut(this)") %>  
      </div>
    </div>

    <div class="line-forme">
      <div class="forme-lab">
        <label>Rut Destino </label>
        <em class="formee-req">*</em>
      </div>    
      <div class="forme-in">
        <%= f.text_field(:rut, :id => 'rut', :value => "-", :onblur => "search_rut(this)")%>
      </div>
    </div>

    <div class="line-forme">
      <div class="forme-lab">
        <label>Código Destino </label>
        <em class="formee-req">*</em>
      </div>
    
      <div class="forme-in">
        <%= f.text_field(:code, :id => 'codigo', :value => "-", :onblur => "search_code(this)")%>
      </div>
    </div>

    <div class="line-forme">
      <div class="forme-lab">
        <label>Especie </label>
        <em class="formee-req">*</em>
      </div>    
      <div class="forme-in">
        <% @options = Kind.all.map { |k| [k.name, k.id] } %>
        <%= f.select(:kind_id, options_for_select(@options), {:selected => :prompt, :prompt => '- Seleccione especie - '} , :onchange => "show_rut(this)") %>
      </div>    
    </div>

    <div class="line-forme">
      <div class="forme-lab">
        <label>Fecha de Despacho </label>
        <em class="formee-req">*</em>
      </div>    
      <div>
        <%= f.datetime_select :dispatch_datetime %>
      </div>    
    </div>

  </div>  
</div>

<div class="foot-box">
  <div class="line-forme">
    <div class="forme-lab">
      <label>Número Despacho:</label>
    </div>
  
    <div class="forme-in">
      <% dispatchs_array = Dispatch.all.map { |dispatch| [dispatch.code] }%>
      <% if (dispatchs_array.size == 0) %>
        <%= f.text_field(:code, :value => '1', :readonly => true)%>
      <% else %>
        <%= f.text_field(:code, :value => (Integer((dispatchs_array[dispatchs_array.size - 1])[0])+1).to_s, :readonly => true)%>
      <%end%>
    </div>


    <%= link_to 'Cancelar', dispatches_path , :class => "button silver alignright" %>
    <%= f.submit :Aceptar , :class => "button green alignright" %>
  </div>
</div>


<% end %>

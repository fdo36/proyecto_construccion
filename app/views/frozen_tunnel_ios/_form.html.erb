<script type="text/javascript">

function add_pallet(){
  $("#error_label").text("");
  $.get("/packing_pallets.json", function(pallets) {
    flag = false;
    $.each(pallets, function(index, pallet){
      flag2 = false;
      if (pallet.pallet_code == $("#code_pallet").val()) {
        $('#tunnel_table tbody tr').each(function(index){
          var code = $(this).find("td").eq(0).text();
          if (pallet.pallet_code == code) {
            flag2 = true;
          }
        });
        if(flag2==false){
          flag = true;
          $('#tunnel_table').dataTable().fnAddData([
             pallet.pallet_code,
             pallet.pack_type_id,
             pallet.gross_weight,
             "<a onclick='delete_row(this);'>Eliminar</a>"
          ]);
        }  
      }
    });
    if (!flag){
      $("#error_label").text("Ingrese un código válido");
    }
     
    $("#code_pallet").val("");
  });
}

function delete_row(button)
{
  var currentRow = $(button).closest('tr');
  $("#tunnel_table").dataTable().fnDeleteRow(currentRow[0]);
}

function add_pallets(){
  var p_tunnel_temperature = $("#frozen_tunnel_io_tunnel_temperature").val();
  var p_pallet_temperature = $("#frozen_tunnel_io_packing_pallet_temperature").val();
  var p_order_number = $("#frozen_tunnel_io_order_number").val();
  var p_worker_id = $("#frozen_tunnel_io_worker_id").val();
  var p_tunnel_id = $("#frozen_tunnel_io_tunnel_id").val();
  var p_direction = $('input[name="frozen_tunnel_io[direction]"]:checked').val();
  
  $('#tunnel_table tbody tr').each(function(index){
     var code = $(this).find("td").eq(0).text();
     $.get("/packing_pallets.json", function(pallets) {
       $.each(pallets, function(index, pallet){
        if (pallet.pallet_code == code) {
          p_packing_pallet_id = pallet.id;
          $.ajax({
              url: "/frozen_tunnel_ios/",
              type: "POST",
              data: {frozen_tunnel_io:{  order_number: p_order_number,
                                      packing_pallet_temperature: p_pallet_temperature,
                                      tunnel_id: p_tunnel_id,
                                      tunnel_temperature: p_tunnel_temperature,
                                      packing_pallet_id: p_packing_pallet_id,
                                      direction: p_direction,
                                      worker_id: p_worker_id          
                                    }
                      }                      
            }).done(function(){
              window.location = "/frozen_tunnel_ios"
            });
        }
       });
     });
  });
}

</script>

<div class="box">

<%= form_for(@frozen_tunnel_io) do |f| %>
  <% if @frozen_tunnel_io.errors.any? %>
    <div id="error_explanation">
      <h2><%= @frozen_tunnel_io.errors.count > 1 ? "#{@frozen_tunnel_io.errors.count} errores." : "#{@frozen_tunnel_io.errors.count} error." %> No se puede guardar el tunel de congelado:</h2>
      <ul>
      <% @frozen_tunnel_io.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="line-forme">
    <div class="forme-lab">
      <label> 
        Número de Orden
      </label>  
    </div>
    <div class="forme-in">
      <%= f.text_field :order_number %>
    </div>
  </div>


  <div class="line-forme">
    <div class="forme-lab">
      <label> 
        Túnel
      </label>  
    </div>
    <div class="forme-in">
      <% tunnels_array = Tunnel.select { |t| t.is_delete == 0}%>
      <% tunnels_array = tunnels_array.map { |e| [e.name, e.id] } %>
      <%= f.select(:tunnel_id, tunnels_array, :prompt => "Seleccione un Tunel") %>      
    </div>
  </div>

    <div class="line-forme">
    <div class="forme-lab">
      <label> 
        Temperatura Túnel
      </label>  
    </div>
    <div class="forme-in">
      <%= f.text_field :tunnel_temperature %>
    </div>
  </div>

    <div class="line-forme">
    <div class="forme-lab">
      <label> 
        Temperatura Pallets
      </label>  
    </div>
    <div class="forme-in">
       <%= f.text_field :packing_pallet_temperature %>
    </div>
  </div>  

  <div class="line-forme">
    <div class="forme-lab">
      <label> 
        Encargado
      </label>  
    </div>
    <div class="forme-in">
      <%= f.text_field :worker_id %>
    </div>
  </div>

  <div class="line-forme">
    <div class="forme-lab">
      <label> 
        Tipo
      </label>  
    </div>
    <div class="forme-in">
      <%= f.radio_button(:direction, true) %>
        <%= label_tag(:label1, "Entrada") %>
        <%= f.radio_button(:direction,false) %>
        <%= label_tag(:label1, "Salida") %>
    </div>

  </div>  

  <% end %>


  <div class="headContent">
    <h1>Agregar Pallet</h1>
  </div>
  <div class="box">

    <div class="line-forme">
      <div class="forme-lab">
        <label> 
          Pallet
        </label>  
      </div>
      <div class="forme-in">
        <%= text_field(:code, :pallet)%>
      </div>
      <div class="forme-in">
        <label id="error_label", style="color: red;"></label>
      </div>      
      <%= button_tag "Agregar Pallet" , :class => "button green alignright", :onclick => "add_pallet();"%>
    </div>

    <table cellpadding="0" cellspacing="0" border="0" class="display datatable" id="tunnel_table">
      <thead>
        <tr>    
          <th>Código de Pallet</th>
          <th>Tipo de Pack</th>
          <th>Peso Bruto</th>  
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
      </tbody>
    </table>

  </div>


</div>

<div class="foot-box">
    <%= link_to 'Cancelar', frozen_tunnel_ios_path , :class => "button silver alignright" %>
    <%= button_tag "Agregar" , :class => "button green alignright", :onclick => "add_pallets();"%>
</div>